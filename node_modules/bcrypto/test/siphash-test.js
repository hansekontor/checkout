'use strict';

const assert = require('assert');
const sh = require('../lib/siphash');

const {
  siphash,
  siphash32,
  siphash64,
  siphash32k256,
  siphash64k256,
  sipmod
} = sh;

const vectors = [
  [
    [1919933255, -586281423],
    1959329148,
    [407160822, -119421961],
    2135823131,
    [242724075, 1948112272],
    [858247211, -452575434]
  ],
  [
    [1962424773, -1814272003],
    666856046,
    [-2075165842, 1297030679],
    1864740082,
    [326542940, -1049559167],
    [896656651, 165137819]
  ],
  [
    [225214473, -643215526],
    1602249423,
    [2064649584, 1777865131],
    600511913,
    [-2123440997, -410744444],
    [11809533, 1215607540]
  ],
  [
    [-2056821098, -671384019],
    -2062743583,
    [931574962, 1370862253],
    -273301222,
    [-1117138720, 532322123],
    [1166318172, 1927916152]
  ],
  [
    [-819489568, 661751735],
    1277625182,
    [2096117503, -1793359630],
    -1252758318,
    [1332102705, -50377762],
    [-1482618655, 849973233]
  ],
  [
    [410408292, -845568371],
    -123151958,
    [854665844, -1992203585],
    681690827,
    [2127786663, 738990629],
    [39216821, -1141477095]
  ],
  [
    [-876001682, 1493099470],
    1828588917,
    [1013827458, 371765715],
    -59016073,
    [1691066507, -494868711],
    [-1573334030, -1379105338]
  ],
  [
    [-1425932043, -1962815177],
    -385024968,
    [-745471036, -1700709960],
    1423594938,
    [1508454007, 1131726831],
    [1916513612, 193692938]
  ],
  [
    [-1812597383, -1701632926],
    -850090636,
    [-1986969290, -1340990410],
    999589441,
    [-1516888933, 234992524],
    [1434739769, 1839781133]
  ],
  [
    [-1644133665, 195683504],
    1827962802,
    [-1170990524, -987357721],
    -1705670560,
    [1711686188, 1708924743],
    [1636082059, -1790115721]
  ],
  [
    [2052963269, -1797408269],
    -1762378041,
    [1594935806, 2083846478],
    -1212064792,
    [-843480664, 1072933947],
    [981301578, 1227603535]
  ],
  [
    [-189583546, 577482151],
    1110938012,
    [501260199, 288287236],
    730678177,
    [-1765057757, 1054429211],
    [-370798712, -697550475]
  ],
  [
    [1964937148, -2045843973],
    2070294736,
    [-365548787, 1024255718],
    660341694,
    [-1325678327, 2047461542],
    [898953992, 1399665231]
  ],
  [
    [350901799, -1065075312],
    -902301089,
    [-2045375863, 513322370],
    1348590529,
    [1338542393, -1219620619],
    [28668919, -742435100]
  ],
  [
    [-148649328, -1904545042],
    402995175,
    [-636143015, -219288269],
    -639122580,
    [1662431799, 2141278979],
    [-292153885, -155146016]
  ],
  [
    [-1591096735, 1237206501],
    64443056,
    [1786334913, -1903807766],
    -1828506585,
    [-1712123501, 949137435],
    [1702205280, -773283787]
  ],
  [
    [1059769471, 1472371675],
    1503153800,
    [-251110780, 654832767],
    444441527,
    [1046782326, 1125415262],
    [261494734, 1784006599]
  ],
  [
    [1771760117, 750667668],
    2064806032,
    [1967767266, -2069081642],
    -110290053,
    [-385842146, -10839401],
    [730886569, 1870537190]
  ],
  [
    [1270985712, -1769090148],
    -226920367,
    [1507275731, -2078469954],
    1456131882,
    [966379030, 1180931379],
    [376115711, -948670341]
  ],
  [
    [-1150432995, -1485217347],
    1254975048,
    [-183181643, 926700101],
    1408606776,
    [-324890155, -2052147007],
    [-1992715546, 871073427]
  ],
  [
    [-1093247758, 446885528],
    1113224568,
    [326587373, 2053400782],
    -109413604,
    [734276660, -2031828352],
    [-1908218506, -435336532]
  ],
  [
    [-789394512, 775645127],
    -1188748242,
    [-1361900978, -471712614],
    1818082894,
    [1440312414, -192063200],
    [-1433702076, 105436037]
  ],
  [
    [-1823250539, -475840888],
    -316317376,
    [1929575369, 680227573],
    -643678489,
    [-1716003804, 1794435066],
    [1422451746, 2022247066]
  ],
  [
    [-1475607668, -849555768],
    1418269382,
    [387201960, -4294246],
    190325599,
    [1541010168, -2130460942],
    [1850721593, 583641691]
  ],
  [
    [-1196601146, -162943084],
    1287376790,
    [-1347256907, 407697041],
    -560770707,
    [-327398460, -1266787006],
    [-2059822732, 1215283340]
  ],
  [
    [-1126067490, -1970947862],
    -1144122022,
    [-1115496914, -1360034869],
    -1189814971,
    [90557544, 601868331],
    [-1956899206, 1525055003]
  ],
  [
    [400045496, 1538987507],
    1282441518,
    [-801564524, -1590963763],
    -773010344,
    [-507328974, 1178440620],
    [37261377, -757316506]
  ],
  [
    [791568739, 124506029],
    2085149459,
    [1094535996, -1299148892],
    -1597987978,
    [1892431498, -2066707737],
    [145887273, -2124647698]
  ],
  [
    [-565335380, -1491220059],
    -1043419264,
    [-1977657795, 66473189],
    813665851,
    [378130852, 1669567669],
    [-1056257133, -1887570934]
  ],
  [
    [-1499312026, -2020252303],
    -756231722,
    [877007133, -2094064068],
    -570813179,
    [-822760658, 473244844],
    [1819731758, -757492112]
  ],
  [
    [-1383619757, 1548349224],
    -679456510,
    [-1764629793, 240409571],
    111151225,
    [-896100327, 209849668],
    [1973459612, 1423607265]
  ],
  [
    [853054202, -666778814],
    -1471200861,
    [-1830322585, -1705725581],
    830586903,
    [703001620, -760656431],
    [169431202, 1479127989]
  ],
  [
    [1898402095, 1928494286],
    -420044532,
    [-1623610006, 978667482],
    -896738932,
    [1914492198, -1457732089],
    [839105461, -1179768936]
  ],
  [
    [-1477237946, -111576861],
    -439835898,
    [519893024, -285038360],
    -108778552,
    [885297347, 179925169],
    [1848581874, -1762879633]
  ],
  [
    [316715034, -1157295560],
    1012133915,
    [1009205013, -1577075474],
    -1137981203,
    [1548001863, -2118283112],
    [23354872, 1782104929]
  ],
  [
    [367015124, 262248366],
    835875031,
    [-1931940878, -1246694339],
    -1992434684,
    [-1413110901, 1290764230],
    [31362311, 1217573807]
  ],
  [
    [827195326, 135635892],
    1345087200,
    [1556380242, -1136985443],
    126839854,
    [-813445393, 1448617632],
    [159314858, -1763359014]
  ],
  [
    [41521392, 694303105],
    -396116432,
    [716435298, -937541686],
    -809400395,
    [616762894, 789929058],
    [401406, 364623772]
  ],
  [
    [-891497243, -1628173235],
    690231662,
    [1530810931, -842520001],
    564237421,
    [670123155, -1554166998],
    [-1597948296, -91261928]
  ],
  [
    [-1698703242, 1781756764],
    472554872,
    [-1251060726, 1203820032],
    1475114926,
    [1508922033, -1731172306],
    [1569415219, 796944781]
  ],
  [
    [238987627, 1392814032],
    245129839,
    [5843620, -1657655835],
    1233390685,
    [349940073, 2087762803],
    [13298142, 1026529590]
  ],
  [
    [-1391705386, -61318766],
    1031804450,
    [1066157991, 1009442433],
    -1753851887,
    [1557601222, 1988323961],
    [1962513132, -425025536]
  ],
  [
    [410191560, -1681779287],
    -1483083447,
    [-1264338109, -249407841],
    -1044857031,
    [1899220884, 711818298],
    [39175412, -1247913745]
  ],
  [
    [-727315780, -210162795],
    -1420356765,
    [-881925487, 1574859272],
    -509758092,
    [-1637618108, -1792074393],
    [-1331466886, -524304433]
  ],
  [
    [-113949411, -453894670],
    1559573661,
    [-1797772068, 230807660],
    1545136668,
    [-886179072, -441198256],
    [-224875639, -664212631]
  ],
  [
    [-1454141692, 427120519],
    1448360184,
    [1806714776, 940569228],
    122074035,
    [2025255539, 741461672],
    [1879010841, 1982530600]
  ],
  [
    [-610611745, -177429232],
    152471885,
    [1814198561, 815896171],
    -406632231,
    [-682307760, -564984253],
    [-1134413351, -2064933859]
  ],
  [
    [-798189363, 1544123883],
    -1246825624,
    [-1375256364, -1904436842],
    347953411,
    [-1262628547, -2138348297],
    [-1448040866, -32929375]
  ],
  [
    [-434986037, -1630820015],
    -968233139,
    [2128289524, -1808181666],
    -610836753,
    [-165602001, 395774749],
    [-825917523, 1388656397]
  ],
  [
    [-949557716, -55726186],
    -2138942464,
    [1699615665, 320801356],
    299641203,
    [-557278451, -633280709],
    [-1689181386, 732184403]
  ],
  [
    [-295419046, -1756168590],
    -1863961483,
    [-1066412429, -9177069],
    2040301997,
    [-1644037809, -1567032514],
    [-570518399, 568137014]
  ],
  [
    [-1584212618, -1304095142],
    -1256260536,
    [165977545, -1366296928],
    700398272,
    [-1585530392, -2018530872],
    [1710884023, 2040330394]
  ],
  [
    [176654271, -1899268942],
    2029995389,
    [-2143690028, -1139385178],
    162989068,
    [2143456020, 493140035],
    [7265883, 1798051747]
  ],
  [
    [-2118916291, 548707183],
    1174044549,
    [-1004203732, -383544934],
    1262129985,
    [-483398733, 1333397516],
    [1102499192, -883875627]
  ],
  [
    [2141725195, -1548555030],
    766435028,
    [392908597, 1788474526],
    -1593994048,
    [-1948699475, 1729398138],
    [1067991092, 1077508586]
  ],
  [
    [609694145, 1017390233],
    131661366,
    [-2028913319, 928252846],
    197555365,
    [-1968652033, -319465455],
    [86549425, 873524463]
  ],
  [
    [-1215447121, 982352829],
    -280914782,
    [-1253339011, -806204254],
    -2002235805,
    [-2074146878, 1962410084],
    [-2086930807, 1011073931]
  ],
  [
    [-367340187, 841619979],
    -1011152291,
    [-408660585, -93061319],
    -1395394173,
    [-124377176, 1094841484],
    [-703262483, 170177956]
  ],
  [
    [1625693219, -1552330733],
    -1165062341,
    [-274588244, -151282140],
    1979160858,
    [-1907586799, -1698594979],
    [615343089, 1304201922]
  ],
  [
    [1711724516, 1177037715],
    556166224,
    [-1920307825, 1769274875],
    1686600881,
    [-786915537, -1990704678],
    [682193976, -1129544193]
  ],
  [
    [1822747825, 1549767137],
    1967858716,
    [-78203787, 1873375287],
    -1789898982,
    [-227053018, 980238902],
    [773558773, -1006208327]
  ],
  [
    [-1620939359, 1553343987],
    -83359793,
    [543964869, 677672213],
    -1498250715,
    [1477736160, -1023899026],
    [1664838150, -1887423322]
  ],
  [
    [-451200928, -1896718505],
    362421398,
    [-1996342823, -758920317],
    -1136466290,
    [-1654957424, -754288256],
    [-855001663, -1333385049]
  ],
  [
    [-1786105268, -351910542],
    -1611603439,
    [2108868877, -1106868451],
    243835367,
    [698559133, 1622340151],
    [1465526567, -832253308]
  ]
];

function toHex(hi, lo) {
  hi >>>= 0;
  lo >>>= 0;

  hi = hi.toString(16);
  lo = lo.toString(16);

  while (hi.length < 8)
    hi = '0' + hi;

  while (lo.length < 8)
    lo = '0' + lo;

  return hi + lo;
}

describe('SipHash', function() {
  it('should perform siphash with no data', () => {
    const data = Buffer.alloc(0);
    const key = Buffer.from('000102030405060708090a0b0c0d0e0f', 'hex');
    assert.deepStrictEqual(siphash(data, key), [1919933255, -586281423]);
  });

  it('should perform siphash with data', () => {
    const data = Buffer.from('0001020304050607', 'hex');
    const key = Buffer.from('000102030405060708090a0b0c0d0e0f', 'hex');
    assert.deepStrictEqual(siphash(data, key), [-1812597383, -1701632926]);
  });

  it('should perform siphash with uint256', () => {
    const data = Buffer.from(
      '000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f',
      'hex');
    const key = Buffer.from('000102030405060708090a0b0c0d0e0f', 'hex');
    assert.deepStrictEqual(siphash(data, key), [1898402095, 1928494286]);
  });

  it('should test sipmod', () => {
    const value = Buffer.from([0xab]);
    const key = Buffer.from('9dcb553a73b4e2ae9316f6b25f848656', 'hex');

    assert.deepStrictEqual(
      sipmod(value, key, 0, 100),
      [0, 93]);

    assert.deepStrictEqual(
      sipmod(value, key, 100, 100),
      [93, -24689725]);

    assert.deepStrictEqual(
      sipmod(value, key, 0, 0x1fffffff),
      [0, 504627794]);

    assert.deepStrictEqual(
      sipmod(value, key, 0, 0xffffffff),
      [0, -257944937]);

    assert.deepStrictEqual(
      sipmod(value, key, 0x000000ff, 0xffffffff),
      [240, -1609394163]);

    assert.deepStrictEqual(
      sipmod(value, key, 0x1fffffff, 0xffffffff),
      [504627795, 30211052]);

    assert.deepStrictEqual(
      sipmod(value, key, 0xffffffff, 0xffffffff),
      [-257944936, 241688429]);
  });

  for (let i = 0; i < vectors.length; i++) {
    const [[hi, lo], h32, h64, k32, k64, mod] = vectors[i];
    const msg = Buffer.alloc(i, 0x00);

    for (let j = 0; j < i; j++)
      msg[j] = j & 0xff;

    it(`should get siphash of 0x${toHex(hi, lo)}`, () => {
      const key = Buffer.from('000102030405060708090a0b0c0d0e0f', 'hex');
      const k256 = Buffer.concat([key, key]);

      assert.deepStrictEqual(siphash(msg, key), [hi, lo]);
      assert.strictEqual(siphash32(lo, key), h32);
      assert.deepStrictEqual(siphash64(hi, lo, key), h64);
      assert.strictEqual(siphash32k256(lo, k256), k32);
      assert.deepStrictEqual(siphash64k256(hi, lo, k256), k64);
      assert.deepStrictEqual(sipmod(msg, key, hi, lo), mod);
    });
  }
});
